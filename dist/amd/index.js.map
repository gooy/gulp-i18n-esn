{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourceRoot":"/source/","sourcesContent":["import through from \"through2\";\nimport gutil from \"gulp-util\";\nimport fs from \"graceful-fs\";\nimport deepExtend from \"deep-extend\";\nimport File from \"vinyl\";\nimport {getExtension, hashFromString} from \"./utils\";\n\nconst minimist = require(\"minimist\");\n\nlet knownOptions = {\n  string: \"env\",\n  default: {\n    env: process.env.NODE_ENV || \"production\",\n    verbose: false,\n  },\n};\n\nlet cmdOptions = minimist(process.argv.slice(2), knownOptions);\n\nlet PluginError = gutil.PluginError;\nconst PLUGIN_NAME = \"gulp-i18n-esn\";\n\nexport class Plugin{\n\n  registry = [];\n  values = {};\n  nodes = {};\n\n  constructor(opts){\n    if(opts) Object.assign(this, opts);\n  }\n\n  /**\n   * Figures out how to parse the data based on file extension.\n   *\n   * @param path          path to the file\n   * @param data          data of the file\n   * @returns {Promise}   resolved when data has been parsed\n   */\n  parseTranslations(path, data){\n    let ext = getExtension(path);\n\n    switch(ext){\n      case \"html\":\n        if(cmdOptions.verbose) gutil.log(\"parse HTML:\", path);\n        return this.parseHTML(data);\n      default:\n        if(cmdOptions.verbose) gutil.log(\"parse JS:\", path);\n        return this.parseJavaScript(path);\n    }\n  }\n\n  parseJavaScript(path){\n    let pos = path.lastIndexOf(\".\");\n    if(pos > -1) path = path.substr(0, pos);\n\n    return System.import(path).then(mod=>{\n      return mod.translations;\n    });\n  }\n\n  /**\n   * Parse and add keys to the registry.\n   * @param keys\n   */\n  addToRegistry(lang, data){\n    if(!this.registry[lang]) this.registry[lang] = {};\n\n    deepExtend(this.registry[lang], data);\n  }\n\n  generateAllTranslations(){\n    if(cmdOptions.verbose) {\n      gutil.log(\"extracted registry:\");\n      gutil.log(this.registry);\n    }\n\n    for(let lang in this.registry){\n      if(!this.registry.hasOwnProperty(lang)) continue;\n      this.generateTranslation(lang, this.registry[lang]);\n    }\n  }\n\n  generateTranslation(lang){\n    this.registryHash = {};\n\n    let translation = this.registry[lang];\n\n    // turn the array of keys\n    // into an associative object\n    // ==========================\n    for(let key in translation){\n      if(!translation.hasOwnProperty(key)) continue;\n      this.registryHash = hashFromString(key, translation[key], this.keySeparator, this.registryHash);\n    }\n\n    // push files back to the stream\n    let file = new File({\n      path: `translations-${lang}.json`,\n      // base: locale,\n      contents: new Buffer(JSON.stringify(this.registryHash, null, 2)),\n    });\n    this.stream.push(file);\n  }\n\n\n  // --------- Stream functions\n\n  parse(){\n    return this.stream = through.obj(this.transformFile.bind(this), this.flush.bind(this));\n  }\n\n  transformFile(file, encoding, done){\n    let data, path;\n\n    // we do not handle streams\n    if (file.isStream()) {\n      this.emit(\"error\", new PluginError(PLUGIN_NAME, \"Streams are not supported!\"));\n      return done();\n    }\n\n    // read the file manually if a filepath was passed.\n    if(file.isNull()){\n      path = file.path;\n      if(file.stat.isDirectory()){\n        return done();\n      }else if(path && fs.existsSync(path)){\n        data = fs.readFileSync(path);\n      }else{\n        this.emit(\"error\", new PluginError(PLUGIN_NAME, \"File has no content and is not readable\"));\n        return done();\n      }\n    }\n\n    let segments = file.path.split(\"/\");\n    let lang = segments[segments.length - 2];\n\n    if (file.isBuffer()) {\n      path = file.path.replace(process.cwd() + \"/\", \"\");\n      data = file.contents.toString();\n    }\n\n    // skip if no data was found\n    if(!data) return done();\n\n    this.parseTranslations(path, data).then(trans=>{\n      this.addToRegistry(lang, trans);\n      // tell the stream engine that we are done with this file\n      done();\n    });\n  }\n\n  flush(cb){\n    // extract values from the aurelia application where possible\n    this.generateAllTranslations();\n    cb();\n  }\n}\n\n/**\n * The main plugin function\n *\n * @param opts\n * @returns {Stream}\n */\nexport function i18n(opts) {\n  return new Plugin(opts).parse();\n}\n"]}